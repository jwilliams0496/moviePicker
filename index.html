<html>
<header>

    <title>Find a Movie</title>

    <!-- Uses AJAX and mootools to send a GET request to server to access csv with data
        Code from: https://stackoverflow.com/questions/3567369/reading-server-side-file-with-javascript/3567423 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/index.css">

    <script src="js/papaparse.js" type="text/javascript"></script>
    <script src="js/parseData.js" type="text/javascript"></script>

</header>

<body>
    <!-- Angularjs View -->
    <div id="id4Angular" ng-app="mainApp" ng-controller="surveyController">
        <h2>Find a Movie to Watch</h2>

        <!-- table will go here -->

    </div>
</body>

<script>
    //ACTUAL CODE STARTS EXECUTING HERE

    // When the DOM is fully loaded, mootools request all the CSV's and convert to JSON through Papa Parse
    window.addEvent("domready", function () {
        var moviesReady = false;
        var keywordsReady = false;

        //AJAX request csv that is server side
        var moviesRequest = new Request(
            {
                url: "data/movies_metadata.csv",
                // onSuccess is asyncronous, so schedule before using data!
                onSuccess: function (response) {

                    // send movie data to angularjs controller
                    var scope = angular.element(document.getElementById('id4Angular')).scope();
                    scope.setMovies(parseData(response));

                    // let controller know data is ready, (movies unlocked)
                    scope.moviesReady = true;

                }
            }).send();

        //AJAX request csv that is server side
        var keywordsRequest = new Request(
            {
                url: "data/keywords.csv",
                // onSuccess is asyncronous, so schedule before using data!
                onSuccess: function (response) {

                    // send keyword data to angularjs controller
                    var scope = angular.element(document.getElementById('id4Angular')).scope();
                    scope.setKeywords(parseData(response));

                    // let controller know data is ready, (keywords unlockeds)
                    scope.keywordsReady = true;

                }
            }).send();

    });

    // Angularjs Controller
    var mainApp = angular.module("mainApp", []);

    mainApp.controller('surveyController', function ($scope) {

        // all the data
        $scope.moviesJSON;
        $scope.keywordsJSON;

        // locks for data (locked until data is available)
        $scope.moviesReady = false;
        $scope.keywordsReady = false;

        // String with Output
        $scope.resultList = "";
        // list of calculated results
        $scope.userResults = [];

        // input: two JSON array lists
        $scope.setMovies = function(movies) {
            $scope.moviesJSON = movies;

            // console logs for debug
            console.log("Movies Recieved:");
            console.log($scope.moviesJSON);
        }

        $scope.setKeywords = function(keywords) {
            $scope.keywordsJSON = keywords;

            // console logs for debug
            console.log("Keywords Recieved:");
            console.log($scope.keywordsJSON);
        }

        $scope.execute = function () {
            // "lock" is closed, prevent interaction until data is ready
            if (!$scope.moviesReady || !$scope.keywordsReady) {
                alert("Hold on, the data isn't ready yet. Try again in a few seconds.")
                return;
            }

        }

        // the most barbaric way to print the results
        $scope.getTopTen = function () {
            $scope.resultList = [];
            $scope.resultList.push($scope.userResults[0]);
            $scope.resultList.push($scope.userResults[1]);
            $scope.resultList.push($scope.userResults[2]);
            $scope.resultList.push($scope.userResults[3]);
            $scope.resultList.push($scope.userResults[4]);
        }
    });

</script>

</html>