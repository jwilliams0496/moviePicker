<html>
<header>

    <title>Accidents Happen</title>

    <!-- Uses AJAX and mootools to send a GET request to server to access csv with data
        Code from: https://stackoverflow.com/questions/3567369/reading-server-side-file-with-javascript/3567423 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/index.css">

    <script src="js/papaparse.js" type="text/javascript"></script>
    <script src="js/parseData.js" type="text/javascript"></script>
    <script src="incidentData.csv" type="text/csv" id="unparsedData"></script>

</header>

<body>
    <!-- Angularjs View -->
    <div id="id4Angular" ng-app="mainApp" ng-controller="surveyController">
        <h2>Find a Movie to Watch</h2>

        <!-- table will go here -->

    </div>
</body>

<script>
    //ACTUAL CODE STARTS EXECUTING HERE

    // When the DOM is fully loaded, mootools request all the CSV's and convert to JSON through Papa Parse
    window.addEvent("domready", function () {

        // send requests
        var movies = requestJSON("data/movies_metadata.csv");
        var keywords = requestJSON("data/keywords.csv");

        // tell angularjs controller the data is ready
        var scope = angular.element(document.getElementById('id4Angular')).scope();
        scope.setData(movies, keywords);

    });

    // Angularjs Controller
    var mainApp = angular.module("mainApp", []);

    mainApp.controller('surveyController', function ($scope) {

        // all the data
        $scope.moviesJSON;
        $scope.keywordsJSON;
        $scope.dataReady = false;

        // String with Output
        $scope.resultList = "";
        // list of calculated results
        $scope.userResults = [];

        // input: two JSON array lists
        $scope.setData = function(movies, keywords) {
            // set data in controller, and open "lock" on website
            $scope.moviesJSON = movies;
            $scope.keywordsJSON = keywords;
            $scope.dataReady = true;

            // console logs for debug
            console.log("Movies Recieved:");
            console.log($scope.moviesJSON);
            console.log("Keywords Recieved:");
            console.log($scope.keywordsJSON);

        }

        $scope.execute = function () {
            // "lock" is closed, prevent interaction until data is ready
            if (!$scope.dataReady) {
                alert("Hold on, the data isn't ready yet. Try again in a few seconds.")
                return;
            }

        }

        // the most barbaric way to print the results
        $scope.getTopTen = function () {
            $scope.resultList = [];
            $scope.resultList.push($scope.userResults[0]);
            $scope.resultList.push($scope.userResults[1]);
            $scope.resultList.push($scope.userResults[2]);
            $scope.resultList.push($scope.userResults[3]);
            $scope.resultList.push($scope.userResults[4]);
        }
    });

</script>

</html>